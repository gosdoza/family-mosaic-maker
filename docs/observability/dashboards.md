# 健康儀表板需求說明

**版本**: v1.0.0  
**最後更新**: 2025-11-09

本文档定义健康仪表板的需求说明，包括 KPI 指标、更新频率和实现方案。

## 📋 目錄

- [儀表板概述](#儀表板概述)
- [KPI 指標](#kpi-指標)
- [更新頻率](#更新頻率)
- [實現方案](#實現方案)
- [儀表板欄位](#儀表板欄位)
- [告警規則](#告警規則)

## 🔍 儀表板概述

### 儀表板目的

提供實時的健康監控儀表板，追蹤關鍵業務指標（KPI），包括性能指標（p95）、可靠性指標（失敗率）、成本指標（成本）和業務指標（退款率）。

### 儀表板範圍

- **性能監控**: API 響應延遲（p95）
- **可靠性監控**: 失敗率（上傳、生成、支付）
- **成本監控**: API 調用成本、存儲成本
- **業務監控**: 退款率、轉化率

### 儀表板目標

- **實時性**: 5 分鐘更新一次
- **準確性**: 基於實際事件數據
- **可視化**: 清晰的圖表和指標展示
- **告警**: 自動告警異常情況

## 📊 KPI 指標

### 1. p95（95th Percentile Latency）

**指標說明**: 95% 的請求響應時間小於此值

**計算方式**:
- 記錄每次 API 調用的響應時間
- 計算統計指標（p50, p95, p99）
- 重點關注 p95（關鍵指標）

**健康閾值**:
- **正常**: p95 < 5s
- **警告**: p95 >= 5s 且 < 8s
- **危險**: p95 >= 8s（觸發降級）

**數據來源**:
- API 調用日誌（Logflare）
- Vercel Analytics（性能指標）
- 自定義事件追蹤（`gen_start`, `gen_ok` 事件）

**儀表板顯示**:
- **當前值**: 當前 p95 延遲（秒）
- **趨勢圖**: 過去 24 小時的 p95 趨勢
- **對比**: 與目標值（5s）的對比
- **狀態**: 正常/警告/危險

### 2. 失敗率（Failure Rate）

**指標說明**: 失敗請求數 / 總請求數 * 100%

**計算方式**:
- 統計失敗事件數（`upload_fail`, `gen_fail`, `pay_fail`, `login_fail`）
- 統計總事件數（`upload_start`, `gen_start`, `pay_start`, `login_request`）
- 計算失敗率：`失敗事件數 / 總事件數 * 100%`

**分類**:
- **上傳失敗率**: `upload_fail / upload_start * 100%`
- **生成失敗率**: `gen_fail / gen_start * 100%`
- **支付失敗率**: `pay_fail / pay_start * 100%`
- **登入失敗率**: `login_fail / login_request * 100%`
- **總體失敗率**: `(upload_fail + gen_fail + pay_fail + login_fail) / (upload_start + gen_start + pay_start + login_request) * 100%`

**健康閾值**:
- **正常**: 失敗率 < 1%
- **警告**: 失敗率 >= 1% 且 < 2%
- **危險**: 失敗率 >= 2%（觸發降級）

**數據來源**:
- 事件日誌（Logflare）
- 自定義事件追蹤（`upload_fail`, `gen_fail`, `pay_fail`, `login_fail`）

**儀表板顯示**:
- **當前值**: 當前失敗率（%）
- **分類失敗率**: 上傳、生成、支付、登入失敗率
- **趨勢圖**: 過去 24 小時的失敗率趨勢
- **對比**: 與目標值（1%）的對比
- **狀態**: 正常/警告/危險

### 3. 成本（Cost）

**指標說明**: API 調用成本和存儲成本

**計算方式**:
- **API 調用成本**: `API 調用次數 * 單次調用成本`
- **存儲成本**: `存儲大小（GB）* 每 GB 成本`
- **總成本**: `API 調用成本 + 存儲成本`

**分類**:
- **Runware API 成本**: 圖片生成 API 調用成本
- **Supabase 成本**: 數據庫和存儲成本
- **Vercel 成本**: 部署和帶寬成本
- **總成本**: 所有成本總和

**健康閾值**:
- **正常**: 成本 < 預算的 80%
- **警告**: 成本 >= 預算的 80% 且 < 預算的 95%
- **危險**: 成本 >= 預算的 95%

**數據來源**:
- API 調用日誌（Logflare）
- 事件日誌（`gen_start`, `gen_ok` 事件）
- 訂單數據（`orders` 表）
- 存儲使用量（Supabase Dashboard）

**儀表板顯示**:
- **當前值**: 當前總成本（美元）
- **分類成本**: Runware、Supabase、Vercel 成本
- **趨勢圖**: 過去 30 天的成本趨勢
- **對比**: 與預算的對比
- **預測**: 基於當前趨勢的成本預測
- **狀態**: 正常/警告/危險

### 4. 退款率（Refund Rate）

**指標說明**: 退款訂單數 / 總訂單數 * 100%

**計算方式**:
- 統計退款訂單數（`orders` 表中 `status = 'refunded'`）
- 統計總訂單數（`orders` 表中所有訂單）
- 計算退款率：`退款訂單數 / 總訂單數 * 100%`

**分類**:
- **總體退款率**: `退款訂單數 / 總訂單數 * 100%`
- **按原因分類**: 技術問題、用戶不滿意、其他原因

**健康閾值**:
- **正常**: 退款率 < 2%
- **警告**: 退款率 >= 2% 且 < 5%
- **危險**: 退款率 >= 5%

**數據來源**:
- 訂單數據（`orders` 表）
- 支付日誌（PayPal Webhook 事件）
- 事件日誌（`pay_success`, `pay_fail` 事件）

**儀表板顯示**:
- **當前值**: 當前退款率（%）
- **退款訂單數**: 退款訂單總數
- **趨勢圖**: 過去 30 天的退款率趨勢
- **對比**: 與目標值（2%）的對比
- **原因分析**: 按原因分類的退款統計
- **狀態**: 正常/警告/危險

## ⏱️ 更新頻率

### 更新頻率設定

**更新頻率**: **5 分鐘**

**更新方式**:
- **實時更新**: 每次事件發生時立即更新（可選）
- **定期更新**: 每 5 分鐘更新一次（主要方式）
- **告警更新**: 當指標超過閾值時立即更新

### 更新頻率說明

**為什麼選擇 5 分鐘？**

1. **平衡實時性和性能**
   - 5 分鐘足夠及時發現問題
   - 不會對系統造成過大負擔
   - 適合大多數業務場景

2. **數據準確性**
   - 5 分鐘內有足夠的數據點進行統計
   - 可以準確計算 p95、失敗率等指標
   - 避免因數據量過少導致的統計偏差

3. **告警響應**
   - 5 分鐘內可以及時響應異常情況
   - 不會錯過關鍵問題
   - 適合自動化告警和降級機制

### 更新頻率表

| 指標類型 | 更新頻率 | 說明 |
|---------|---------|------|
| **p95** | 5 分鐘 | 基於過去 5 分鐘的 API 調用數據 |
| **失敗率** | 5 分鐘 | 基於過去 5 分鐘的事件數據 |
| **成本** | 5 分鐘 | 基於過去 5 分鐘的 API 調用和存儲數據 |
| **退款率** | 5 分鐘 | 基於過去 5 分鐘的訂單數據 |

## 🛠️ 實現方案

### 短期方案（當前）

**使用工具**: **Vercel Analytics** 和 **Logflare**

**Vercel Analytics**:
- **用途**: 頁面性能監控、API 響應時間
- **優勢**: 內建於 Vercel，無需額外配置
- **限制**: 主要用於前端性能監控

**Logflare**:
- **用途**: 事件日誌收集、查詢和分析
- **優勢**: 支持結構化日誌查詢、實時查詢
- **限制**: 需要手動配置查詢和儀表板

**實現步驟**:
1. **配置 Vercel Analytics**
   - 在 Vercel Dashboard 中啟用 Analytics
   - 配置自定義事件追蹤
   - 設置性能監控

2. **配置 Logflare**
   - 設置 Logflare 數據源
   - 配置事件日誌收集
   - 創建查詢和儀表板

3. **數據收集**
   - 發送事件到 Logflare（使用 `type=event` 標籤）
   - 記錄 API 調用時間到 Vercel Analytics
   - 定期查詢和聚合數據

4. **儀表板展示**
   - 使用 Logflare 查詢結果創建儀表板
   - 使用 Vercel Analytics 展示性能指標
   - 手動更新或使用自動化腳本

### 長期方案（未來）

**使用工具**: **專用監控服務**（如 Datadog, Grafana, New Relic）

**專用監控服務**:
- **用途**: 完整的監控和告警解決方案
- **優勢**: 自動化儀表板、告警、可視化
- **功能**: 實時監控、歷史數據分析、自定義告警

**實現步驟**:
1. **選擇監控服務**
   - 評估 Datadog, Grafana, New Relic 等選項
   - 選擇最適合的服務

2. **集成監控服務**
   - 配置數據收集
   - 設置儀表板
   - 配置告警規則

3. **自動化**
   - 自動數據收集
   - 自動儀表板更新
   - 自動告警通知

## 📋 儀表板欄位

### 儀表板結構

**儀表板分為 4 個主要區域**:

1. **性能區域**（p95）
2. **可靠性區域**（失敗率）
3. **成本區域**（成本）
4. **業務區域**（退款率）

### 儀表板欄位定義

#### 1. 性能區域（p95）

| 欄位名稱 | 類型 | 說明 | 數據來源 |
|---------|------|------|---------|
| **當前 p95** | `number` | 當前 p95 延遲（秒） | Logflare / Vercel Analytics |
| **p95 趨勢** | `chart` | 過去 24 小時的 p95 趨勢圖 | Logflare / Vercel Analytics |
| **p50 / p99** | `number` | p50 和 p99 延遲（秒） | Logflare / Vercel Analytics |
| **狀態** | `badge` | 正常/警告/危險 | 基於閾值計算 |
| **目標值** | `number` | 目標 p95 值（5s） | 固定值 |
| **更新時間** | `timestamp` | 最後更新時間 | 系統時間 |

#### 2. 可靠性區域（失敗率）

| 欄位名稱 | 類型 | 說明 | 數據來源 |
|---------|------|------|---------|
| **當前失敗率** | `number` | 當前總體失敗率（%） | Logflare |
| **上傳失敗率** | `number` | 上傳失敗率（%） | Logflare |
| **生成失敗率** | `number` | 生成失敗率（%） | Logflare |
| **支付失敗率** | `number` | 支付失敗率（%） | Logflare |
| **登入失敗率** | `number` | 登入失敗率（%） | Logflare |
| **失敗率趨勢** | `chart` | 過去 24 小時的失敗率趨勢圖 | Logflare |
| **狀態** | `badge` | 正常/警告/危險 | 基於閾值計算 |
| **目標值** | `number` | 目標失敗率（1%） | 固定值 |
| **更新時間** | `timestamp` | 最後更新時間 | 系統時間 |

#### 3. 成本區域（成本）

| 欄位名稱 | 類型 | 說明 | 數據來源 |
|---------|------|------|---------|
| **當前總成本** | `number` | 當前總成本（美元） | Logflare / Supabase / Vercel |
| **Runware 成本** | `number` | Runware API 調用成本（美元） | Logflare |
| **Supabase 成本** | `number` | Supabase 數據庫和存儲成本（美元） | Supabase Dashboard |
| **Vercel 成本** | `number` | Vercel 部署和帶寬成本（美元） | Vercel Dashboard |
| **成本趨勢** | `chart` | 過去 30 天的成本趨勢圖 | Logflare / Supabase / Vercel |
| **預算使用率** | `number` | 預算使用率（%） | 基於預算計算 |
| **成本預測** | `number` | 基於當前趨勢的成本預測（美元） | 基於趨勢計算 |
| **狀態** | `badge` | 正常/警告/危險 | 基於閾值計算 |
| **更新時間** | `timestamp` | 最後更新時間 | 系統時間 |

#### 4. 業務區域（退款率）

| 欄位名稱 | 類型 | 說明 | 數據來源 |
|---------|------|------|---------|
| **當前退款率** | `number` | 當前退款率（%） | Supabase (`orders` 表) |
| **退款訂單數** | `number` | 退款訂單總數 | Supabase (`orders` 表) |
| **總訂單數** | `number` | 總訂單數 | Supabase (`orders` 表) |
| **退款率趨勢** | `chart` | 過去 30 天的退款率趨勢圖 | Supabase (`orders` 表) |
| **原因分析** | `chart` | 按原因分類的退款統計 | Supabase (`orders` 表) |
| **狀態** | `badge` | 正常/警告/危險 | 基於閾值計算 |
| **目標值** | `number` | 目標退款率（2%） | 固定值 |
| **更新時間** | `timestamp` | 最後更新時間 | 系統時間 |

## 🚨 告警規則

### 告警規則定義

**告警觸發條件**:
- **p95 >= 8s**: 觸發性能告警
- **失敗率 >= 2%**: 觸發可靠性告警
- **成本 >= 預算的 95%**: 觸發成本告警
- **退款率 >= 5%**: 觸發業務告警

**告警通知方式**:
- **Email**: 發送告警郵件
- **Slack**: 發送到 Slack 頻道
- **SMS**: 發送短信（緊急情況）

**告警頻率**:
- **首次告警**: 立即發送
- **重複告警**: 每 15 分鐘發送一次（如果問題持續）
- **恢復通知**: 問題恢復時立即發送

### 告警規則表

| 指標 | 告警條件 | 告警級別 | 通知方式 | 更新頻率 |
|------|---------|---------|---------|---------|
| **p95** | >= 8s | P0（緊急） | Email + Slack | 每 15 分鐘 |
| **失敗率** | >= 2% | P0（緊急） | Email + Slack | 每 15 分鐘 |
| **成本** | >= 預算的 95% | P1（高） | Email | 每 30 分鐘 |
| **退款率** | >= 5% | P1（高） | Email | 每 30 分鐘 |

## 📤 數據收集

### 數據收集方式

**1. Vercel Analytics**
- **用途**: 頁面性能、API 響應時間
- **配置**: 在 Vercel Dashboard 中啟用
- **數據**: 自動收集，無需額外配置

**2. Logflare**
- **用途**: 事件日誌、API 調用日誌
- **配置**: 設置 Logflare 數據源，發送事件到 Logflare
- **數據**: 使用 `type=event` 標籤發送事件

**3. Supabase**
- **用途**: 訂單數據、退款數據
- **配置**: 查詢 `orders` 表
- **數據**: 定期查詢訂單數據

### 數據收集頻率

| 數據來源 | 收集頻率 | 說明 |
|---------|---------|------|
| **Vercel Analytics** | 實時 | 自動收集，無需手動配置 |
| **Logflare** | 實時 | 事件發生時立即發送 |
| **Supabase** | 5 分鐘 | 定期查詢訂單數據 |

## 📊 樣例查詢

### Logflare 查詢範例

```sql
-- 查詢 p95 延遲（過去 5 分鐘）
SELECT
  percentile(duration, 0.95) as p95
FROM
  logs
WHERE
  type = 'event'
  AND event IN ('gen_start', 'gen_ok')
  AND ts >= NOW() - INTERVAL '5 minutes'

-- 查詢失敗率（過去 5 分鐘）
SELECT
  COUNT(CASE WHEN event IN ('upload_fail', 'gen_fail', 'pay_fail', 'login_fail') THEN 1 END) * 100.0 / 
  COUNT(CASE WHEN event IN ('upload_start', 'gen_start', 'pay_start', 'login_request') THEN 1 END) as failure_rate
FROM
  logs
WHERE
  type = 'event'
  AND ts >= NOW() - INTERVAL '5 minutes'

-- 查詢 API 調用成本（過去 5 分鐘）
SELECT
  COUNT(*) * 0.01 as api_cost
FROM
  logs
WHERE
  type = 'event'
  AND event = 'gen_ok'
  AND ts >= NOW() - INTERVAL '5 minutes'
```

### Supabase 查詢範例

```sql
-- 查詢退款率（過去 5 分鐘）
SELECT
  COUNT(CASE WHEN status = 'refunded' THEN 1 END) * 100.0 / 
  COUNT(*) as refund_rate
FROM
  orders
WHERE
  created_at >= NOW() - INTERVAL '5 minutes'
```

## 📚 相關文檔

- [事件字典 v1](./events-v1.md)
- [Auth 事件監控規範](./auth-events.md)
- [Runware 供應商健康檢查](../runware/health-check.md)

## 📝 更新日誌

- **v1.0.0** (2025-11-09): 初始版本，定義 KPI 指標、更新頻率和實現方案



