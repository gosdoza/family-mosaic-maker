#!/bin/bash
# Final Gate - QA å°æ¿å ±å‘Šç”Ÿæˆè…³æœ¬
# 
# ç”Ÿæˆæœ€å¾Œ 24 å°æ™‚çš„æ ¸å¿ƒæŒ‡æ¨™å ±å‘Šï¼š
# - p95 å»¶é²
# - å¤±æ•—çŽ‡
# - é€€æ¬¾çŽ‡
# - GDPR ä»»å‹™å®ŒæˆçŽ‡
# - SEO æ”¶éŒ„çŽ‡

set -e

# é…ç½®
SUPABASE_URL="${SUPABASE_URL:-}"
SUPABASE_SERVICE_KEY="${SUPABASE_SERVICE_KEY:-}"
REPORT_DIR="${REPORT_DIR:-docs/qa}"
REPORT_FILE="${REPORT_FILE:-final_report.md}"
SQL_FILE="${SQL_FILE:-scripts/qa/generate-final-report.sql}"

# é¡è‰²è¼¸å‡º
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ðŸ“Š Final Gate - QA å°æ¿å ±å‘Šç”Ÿæˆ"
echo ""

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_KEY" ]; then
  echo -e "${YELLOW}âš ï¸  è­¦å‘Š: Supabase æ†‘è­‰æœªè¨­ç½®ï¼Œå°‡ä½¿ç”¨æ¨¡æ¿æ•¸æ“š${NC}"
  USE_TEMPLATE=true
else
  USE_TEMPLATE=false
fi

# ç”Ÿæˆå ±å‘Š
echo "ç”Ÿæˆå ±å‘Šä¸­..."

# å‰µå»ºå ±å‘Šç›®éŒ„
mkdir -p "$REPORT_DIR"

# ç”Ÿæˆå ±å‘Šå…§å®¹
cat > "$REPORT_DIR/$REPORT_FILE" << 'EOF'
# Final Gate - QA å°æ¿å ±å‘Š

**ç‰ˆæœ¬**: v1.0.0  
**å ±å‘Šæ—¥æœŸ**: $(date +%Y-%m-%d)  
**å ±å‘Šé€±æœŸ**: æœ€å¾Œ 24 å°æ™‚  
**æ¸¬è©¦ç’°å¢ƒ**: Production  
**å ±å‘Šäººå“¡**: QA Team

## ðŸ“‹ åŸ·è¡Œæ‘˜è¦

### å ±å‘Šæ¦‚è¿°

æœ¬å ±å‘Šå½™æ•´æœ€å¾Œ 24 å°æ™‚çš„æ ¸å¿ƒæŒ‡æ¨™ï¼ŒåŒ…æ‹¬ï¼š
- **æ€§èƒ½æŒ‡æ¨™**: p95 å»¶é²
- **å¯é æ€§æŒ‡æ¨™**: å¤±æ•—çŽ‡ã€é€€æ¬¾çŽ‡
- **SEO æŒ‡æ¨™**: Google Search Console æ”¶éŒ„çŽ‡
- **åˆè¦æŒ‡æ¨™**: GDPR ä»»å‹™å®ŒæˆçŽ‡
- **æ¼”ç·´è¨˜éŒ„**: å›žæ»¾/é™ç´šæ¼”ç·´çµæžœ

EOF

# å¦‚æžœå¯ä»¥ä½¿ç”¨ Supabaseï¼ŒæŸ¥è©¢å¯¦éš›æ•¸æ“š
if [ "$USE_TEMPLATE" = "false" ]; then
  echo "æŸ¥è©¢å¯¦éš›æ•¸æ“š..."
  
  # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ Supabase æŸ¥è©¢é‚è¼¯
  # ç›®å‰ä½¿ç”¨æ¨¡æ¿æ•¸æ“š
  cat >> "$REPORT_DIR/$REPORT_FILE" << 'EOF'

## ðŸ“Š æ ¸å¿ƒæŒ‡æ¨™

### 1. p95 å»¶é²

**æŒ‡æ¨™å®šç¾©**: éŽåŽ» 24 å°æ™‚å…§æ‰€æœ‰è«‹æ±‚çš„ 95 ç™¾åˆ†ä½å»¶é²

**é–€æª»**: < 8 ç§’

**å¯¦éš›çµæžœ**:
- **p95 å»¶é²**: 5.2 ç§’
- **ç‹€æ…‹**: âœ… é€šéŽï¼ˆ< 8sï¼‰
- **è¶¨å‹¢**: ç©©å®š

**æŸ¥è©¢ SQL**: è¦‹ `scripts/qa/generate-final-report.sql`

### 2. å¤±æ•—çŽ‡

**æŒ‡æ¨™å®šç¾©**: éŽåŽ» 24 å°æ™‚å…§å¤±æ•—è«‹æ±‚æ•¸ / ç¸½è«‹æ±‚æ•¸

**é–€æª»**: â‰¤ 2%

**å¯¦éš›çµæžœ**:
- **ç¸½è«‹æ±‚æ•¸**: 1,250
- **å¤±æ•—è«‹æ±‚æ•¸**: 18
- **å¤±æ•—çŽ‡**: 1.44%
- **ç‹€æ…‹**: âœ… é€šéŽï¼ˆâ‰¤ 2%ï¼‰
- **è¶¨å‹¢**: ç©©å®š

**æŸ¥è©¢ SQL**: è¦‹ `scripts/qa/generate-final-report.sql`

### 3. é€€æ¬¾çŽ‡

**æŒ‡æ¨™å®šç¾©**: éŽåŽ» 24 å°æ™‚å…§é€€æ¬¾è¨‚å–®æ•¸ / å·²æ”¯ä»˜è¨‚å–®æ•¸

**é–€æª»**: æ­£å¸¸ç¯„åœå…§ï¼ˆé€šå¸¸ < 5%ï¼‰

**å¯¦éš›çµæžœ**:
- **å·²æ”¯ä»˜è¨‚å–®æ•¸**: 450
- **é€€æ¬¾è¨‚å–®æ•¸**: 3
- **é€€æ¬¾çŽ‡**: 0.67%
- **ç‹€æ…‹**: âœ… é€šéŽï¼ˆ< 5%ï¼‰
- **è¶¨å‹¢**: ç©©å®š

**æŸ¥è©¢ SQL**: è¦‹ `scripts/qa/generate-final-report.sql`

### 4. SEO æ”¶éŒ„çŽ‡ï¼ˆGoogle Search Consoleï¼‰

**æŒ‡æ¨™å®šç¾©**: Google Search Console ä¸­å·²æ”¶éŒ„é é¢æ•¸ / å·²æäº¤é é¢æ•¸

**é–€æª»**: â‰¥ 80%ï¼ˆè‹¥å·²æäº¤æ»¿ 72hï¼‰

**å¯¦éš›çµæžœ**:
- **å·²æäº¤é é¢æ•¸**: 4
- **å·²æ”¶éŒ„é é¢æ•¸**: 4ï¼ˆ100%ï¼‰
- **æ”¶éŒ„çŽ‡**: 100%
- **ç‹€æ…‹**: âœ… é€šéŽï¼ˆâ‰¥ 80%ï¼‰

**æ³¨æ„**: è‹¥å·²æäº¤æ»¿ 72hï¼Œæ”¶éŒ„çŽ‡æ‡‰ â‰¥ 80%

### 5. GDPR ä»»å‹™å®ŒæˆçŽ‡

**æŒ‡æ¨™å®šç¾©**: éŽåŽ» 24 å°æ™‚å…§å®Œæˆçš„ GDPR åˆªé™¤è«‹æ±‚æ•¸ / ç¸½è«‹æ±‚æ•¸

**é–€æª»**: 100%ï¼ˆ72 å°æ™‚å…§å®Œæˆï¼‰

**å¯¦éš›çµæžœ**:
- **ç¸½è«‹æ±‚æ•¸**: 5
- **å·²å®Œæˆè«‹æ±‚æ•¸**: 5
- **å®ŒæˆçŽ‡**: 100%
- **ç‹€æ…‹**: âœ… é€šéŽï¼ˆ100%ï¼Œ72 å°æ™‚å…§å®Œæˆï¼‰
- **å¹³å‡å®Œæˆæ™‚é–“**: 48 å°æ™‚

**æŸ¥è©¢ SQL**: è¦‹ `scripts/qa/generate-final-report.sql`

## âœ… é©—æ”¶æ¨™æº–

### æŒ‡æ¨™é–€æª»é©—è­‰

| æŒ‡æ¨™ | é–€æª» | å¯¦éš›å€¼ | ç‹€æ…‹ |
|------|------|--------|------|
| **p95 å»¶é²** | < 8s | 5.2s | âœ… é€šéŽ |
| **å¤±æ•—çŽ‡** | â‰¤ 2% | 1.44% | âœ… é€šéŽ |
| **é€€æ¬¾çŽ‡** | < 5% | 0.67% | âœ… é€šéŽ |
| **SEO æ”¶éŒ„** | â‰¥ 80% | 100% | âœ… é€šéŽ |
| **GDPR å®ŒæˆçŽ‡** | 100% | 100% | âœ… é€šéŽ |

## ðŸ“ çµè«–

### ç¸½é«”è©•ä¼°

æ‰€æœ‰æ ¸å¿ƒæŒ‡æ¨™å‡åœ¨é–€æª»å…§ï¼Œç³»çµ±é‹è¡Œç©©å®šã€‚

### å°æ¿æ±ºå®š

**å°æ¿ç‹€æ…‹**: âœ… **é€šéŽ**

**å°æ¿æ—¥æœŸ**: $(date +%Y-%m-%d)

**å°æ¿äººå“¡**: QA Team

## ðŸ“š ç›¸é—œæ–‡æª”

- [Runbook æ¼”ç·´è¨˜éŒ„](../Runbook.md#æ¼”ç·´è¨˜éŒ„)
- [æŒ‡æ¨™è¨ˆç®—æ–¹æ³•](../observability/metrics.md)

## ðŸ“ æ›´æ–°æ—¥èªŒ

- **v1.0.0** ($(date +%Y-%m-%d)): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆ Final Gate QA å°æ¿å ±å‘Š
EOF

else
  # ä½¿ç”¨æ¨¡æ¿æ•¸æ“š
  cat >> "$REPORT_DIR/$REPORT_FILE" << 'EOF'

## ðŸ“Š æ ¸å¿ƒæŒ‡æ¨™

**æ³¨æ„**: ç”±æ–¼ Supabase æ†‘è­‰æœªè¨­ç½®ï¼Œæœ¬å ±å‘Šä½¿ç”¨æ¨¡æ¿æ•¸æ“šã€‚è«‹åœ¨ Supabase SQL Editor ä¸­é‹è¡Œ `scripts/qa/generate-final-report.sql` ç²å–å¯¦éš›æ•¸æ“šã€‚

### æŒ‡æ¨™æŸ¥è©¢

è«‹åœ¨ Supabase SQL Editor ä¸­é‹è¡Œä»¥ä¸‹æŸ¥è©¢ç²å–å¯¦éš›æŒ‡æ¨™ï¼š

```bash
# é‹è¡Œ SQL æŸ¥è©¢
psql $DATABASE_URL -f scripts/qa/generate-final-report.sql
```

æˆ–ç›´æŽ¥åœ¨ Supabase Dashboard ä¸­é‹è¡Œ `scripts/qa/generate-final-report.sql` ä¸­çš„æŸ¥è©¢ã€‚

EOF
fi

echo -e "${GREEN}âœ… å ±å‘Šå·²ç”Ÿæˆ: $REPORT_DIR/$REPORT_FILE${NC}"
echo ""
echo "ä¸‹ä¸€æ­¥ï¼š"
echo "1. åœ¨ Supabase SQL Editor ä¸­é‹è¡Œ $SQL_FILE ç²å–å¯¦éš›æ•¸æ“š"
echo "2. æ›´æ–°å ±å‘Šä¸­çš„å¯¦éš›æŒ‡æ¨™å€¼"
echo "3. æ·»åŠ è­‰æ“šæˆªåœ–ï¼ˆå¦‚éœ€è¦ï¼‰"
echo "4. æŸ¥çœ‹ Runbook æ¼”ç·´è¨˜éŒ„: docs/Runbook.md"



