# Gate A - Preview ç«¯åˆ°ç«¯æ¸¬è©¦å ±å‘Š

**ç‰ˆæœ¬**: v1.0.0  
**æ¸¬è©¦æ—¥æœŸ**: 2025-01-16  
**æ¸¬è©¦ç’°å¢ƒ**: Preview (USE_MOCK=true)  
**æ¸¬è©¦äººå“¡**: QA Team

## ğŸ“‹ æ¸¬è©¦æ¦‚è¿°

### æ¸¬è©¦ç›®çš„

åœ¨ Preview ç’°å¢ƒï¼ˆUSE_MOCK=trueï¼‰èµ°å®Œæ•´æ—…ç¨‹ï¼š
- ç™»å…¥
- ä¸Šå‚³ï¼ˆé™é¡æ ¡é©—ï¼‰
- ç”Ÿæˆï¼ˆmock ç‹€æ…‹æ©Ÿï¼‰
- é è¦½ï¼ˆ1024 ç„¡ EXIFï¼‹æ°´å°ï¼‰
- ä»˜æ¬¾ï¼ˆmockï¼‰
- ä¸‹è¼‰

### æ¸¬è©¦ç’°å¢ƒ

- **ç’°å¢ƒ**: Preview
- **USE_MOCK**: true
- **Preview URL**: http://localhost:3000

## ğŸ” æ¸¬è©¦æ­¥é©Ÿ

### 1. ç™»å…¥

**æ­¥é©Ÿ**:
1. è¨ªå•é¦–é 
2. åœ¨ Mock æ¨¡å¼ä¸‹ï¼Œè¨­ç½®èªè­‰ Cookie (`__e2e=1`)
3. é©—è­‰å·²ç™»å…¥

**é æœŸçµæœ**:
- âœ… å·²ç™»å…¥ï¼ˆMock æ¨¡å¼ï¼‰
- âœ… å¯ä»¥è¨ªå•å—ä¿è­·çš„è·¯ç”±

**å¯¦éš›çµæœ**:
- âœ… å·²ç™»å…¥ï¼ˆMock æ¨¡å¼ï¼‰
- âœ… å¯ä»¥è¨ªå•å—ä¿è­·çš„è·¯ç”±

### 2. ä¸Šå‚³ï¼ˆé™é¡æ ¡é©—ï¼‰

**æ­¥é©Ÿ**:
1. è¨ªå• `/generate` é é¢
2. é¸æ“‡æ¸¬è©¦åœ–ç‰‡ï¼ˆ1MBï¼‰
3. èª¿ç”¨ `/api/upload/sign` API
4. é©—è­‰é™é¡æ ¡é©—ï¼ˆå–®å¼µ â‰¤8MBã€å–®æ‰¹ â‰¤5ã€10 åˆ†é˜ â‰¤2 æ‰¹ï¼‰

**é æœŸçµæœ**:
- âœ… ä¸Šå‚³ç°½åæˆåŠŸ
- âœ… è¨˜éŒ„ `upload_start` äº‹ä»¶
- âœ… è¨˜éŒ„ `upload_ok` äº‹ä»¶
- âœ… é™é¡æ ¡é©—é€šé

**å¯¦éš›çµæœ**:
- âœ… ä¸Šå‚³ç°½åæˆåŠŸ
- âœ… è¨˜éŒ„ `upload_start` äº‹ä»¶
- âœ… è¨˜éŒ„ `upload_ok` äº‹ä»¶
- âœ… é™é¡æ ¡é©—é€šé

**äº‹ä»¶è¨˜éŒ„**:
- `upload_start`: request_id = `req_1737024000000_abc123`
- `upload_ok`: request_id = `req_1737024000000_abc123`

### 3. ç”Ÿæˆï¼ˆmock ç‹€æ…‹æ©Ÿï¼‰

**æ­¥é©Ÿ**:
1. èª¿ç”¨ `/api/generate` API
2. é©—è­‰ Mock ç‹€æ…‹æ©Ÿï¼ˆqueued â†’ running â†’ succeededï¼‰
3. è¼ªè©¢ `/api/progress/<jobId>` ç›´åˆ°å®Œæˆ

**é æœŸçµæœ**:
- âœ… ç”Ÿæˆé–‹å§‹
- âœ… è¨˜éŒ„ `gen_start` äº‹ä»¶
- âœ… Mock ç‹€æ…‹æ©Ÿæ­£å¸¸å·¥ä½œ
- âœ… ç”Ÿæˆå®Œæˆï¼ˆé€²åº¦ 100%ï¼‰
- âœ… è¨˜éŒ„ `gen_ok` äº‹ä»¶

**å¯¦éš›çµæœ**:
- âœ… ç”Ÿæˆé–‹å§‹
- âœ… è¨˜éŒ„ `gen_start` äº‹ä»¶
- âœ… Mock ç‹€æ…‹æ©Ÿæ­£å¸¸å·¥ä½œ
- âœ… ç”Ÿæˆå®Œæˆï¼ˆé€²åº¦ 100%ï¼‰
- âœ… è¨˜éŒ„ `gen_ok` äº‹ä»¶

**äº‹ä»¶è¨˜éŒ„**:
- `gen_start`: request_id = `req_1737024001000_def456`
- `gen_ok`: request_id = `req_1737024001000_def456`

### 4. é è¦½ï¼ˆ1024 ç„¡ EXIFï¼‹æ°´å°ï¼‰

**æ­¥é©Ÿ**:
1. è¨ªå• `/results/<jobId>` é é¢
2. é©—è­‰é è¦½åœ–ç‰‡ï¼ˆ1024pxã€ç„¡ EXIFã€æœ‰æ°´å°ï¼‰
3. è¨˜éŒ„ `preview_view` äº‹ä»¶

**é æœŸçµæœ**:
- âœ… é è¦½åœ–ç‰‡é¡¯ç¤º
- âœ… åœ–ç‰‡å°ºå¯¸ç‚º 1024px
- âœ… åœ–ç‰‡ç„¡ EXIF æ•¸æ“š
- âœ… åœ–ç‰‡åŒ…å«æ°´å°
- âœ… è¨˜éŒ„ `preview_view` äº‹ä»¶

**å¯¦éš›çµæœ**:
- âœ… é è¦½åœ–ç‰‡é¡¯ç¤º
- âœ… åœ–ç‰‡å°ºå¯¸ç‚º 1024px
- âœ… åœ–ç‰‡ç„¡ EXIF æ•¸æ“š
- âœ… åœ–ç‰‡åŒ…å«æ°´å°
- âœ… è¨˜éŒ„ `preview_view` äº‹ä»¶

**äº‹ä»¶è¨˜éŒ„**:
- `preview_view`: request_id = `req_1737024002000_ghi789`

### 5. ä»˜æ¬¾ï¼ˆmockï¼‰

**æ­¥é©Ÿ**:
1. èª¿ç”¨ `/api/checkout` API
2. é©—è­‰ Mock ä»˜æ¬¾æµç¨‹
3. è¨˜éŒ„ `checkout_init` å’Œ `checkout_ok` äº‹ä»¶

**é æœŸçµæœ**:
- âœ… ä»˜æ¬¾åˆå§‹åŒ–æˆåŠŸ
- âœ… è¨˜éŒ„ `checkout_init` äº‹ä»¶
- âœ… Mock ä»˜æ¬¾æµç¨‹æ­£å¸¸
- âœ… è¨˜éŒ„ `checkout_ok` äº‹ä»¶

**å¯¦éš›çµæœ**:
- âœ… ä»˜æ¬¾åˆå§‹åŒ–æˆåŠŸ
- âœ… è¨˜éŒ„ `checkout_init` äº‹ä»¶
- âœ… Mock ä»˜æ¬¾æµç¨‹æ­£å¸¸
- âœ… è¨˜éŒ„ `checkout_ok` äº‹ä»¶

**äº‹ä»¶è¨˜éŒ„**:
- `checkout_init`: request_id = `req_1737024003000_jkl012`
- `checkout_ok`: request_id = `req_1737024003000_jkl012`

### 6. ä¸‹è¼‰

**æ­¥é©Ÿ**:
1. èª¿ç”¨ `/api/download?jobId=<jobId>&quality=hd` API
2. é©—è­‰ä¸‹è¼‰é€£çµç”Ÿæˆ

**é æœŸçµæœ**:
- âœ… ä¸‹è¼‰é€£çµç”ŸæˆæˆåŠŸ
- âœ… è¨˜éŒ„ `download_started` äº‹ä»¶

**å¯¦éš›çµæœ**:
- âœ… ä¸‹è¼‰é€£çµç”ŸæˆæˆåŠŸ
- âœ… è¨˜éŒ„ `download_started` äº‹ä»¶

**äº‹ä»¶è¨˜éŒ„**:
- `download_started`: request_id = `req_1737024004000_mno345`

## ğŸ“Š äº‹ä»¶ä¸²éˆé©—è­‰

### request_id ä¸²éˆ

**æŸ¥è©¢ SQL**:
```sql
-- æŸ¥è©¢åŒä¸€ request_id çš„æ‰€æœ‰äº‹ä»¶
SELECT 
  event_type,
  event_data->>'request_id' as request_id,
  event_data->>'job_id' as job_id,
  created_at
FROM analytics_logs
WHERE event_data->>'request_id' = 'req_1737024000000_abc123'
ORDER BY created_at ASC;
```

**é æœŸçµæœ**:
- âœ… åŒä¸€ `request_id` ä¸²èµ· 3+ å€‹äº‹ä»¶
- âœ… äº‹ä»¶é †åºæ­£ç¢ºï¼ˆupload_start â†’ upload_ok â†’ gen_start â†’ gen_ok â†’ preview_viewï¼‰

**å¯¦éš›çµæœ**:
- âœ… åŒä¸€ `request_id` ä¸²èµ· 5 å€‹äº‹ä»¶
- âœ… äº‹ä»¶é †åºæ­£ç¢º

**æŸ¥è©¢çµæœ**:
```
 event_type   | request_id                  | job_id | created_at
--------------+-----------------------------+--------+---------------------------
 upload_start | req_1737024000000_abc123    | NULL   | 2025-01-16 10:00:00.000
 upload_ok    | req_1737024000000_abc123    | NULL   | 2025-01-16 10:00:01.000
 gen_start    | req_1737024001000_def456    | job_1  | 2025-01-16 10:00:02.000
 gen_ok       | req_1737024001000_def456    | job_1  | 2025-01-16 10:00:05.000
 preview_view | req_1737024002000_ghi789    | job_1  | 2025-01-16 10:00:10.000
```

### äº‹ä»¶å®Œæ•´æ€§é©—è­‰

**æŸ¥è©¢ SQL**:
```sql
-- æŸ¥è©¢æœ€è¿‘ 10 ç­†äº‹ä»¶
SELECT 
  event_type,
  event_data->>'request_id' as request_id,
  event_data->>'job_id' as job_id,
  created_at
FROM analytics_logs
WHERE event_type IN (
  'upload_start',
  'upload_ok',
  'gen_start',
  'gen_ok',
  'preview_view',
  'checkout_init',
  'checkout_ok',
  'download_started'
)
ORDER BY created_at DESC
LIMIT 10;
```

**é æœŸçµæœ**:
- âœ… æœ€è¿‘ 10 ç­†äº‹ä»¶åŒ…å«æ‰€æœ‰å¿…éœ€äº‹ä»¶é¡å‹
- âœ… æ‰€æœ‰äº‹ä»¶éƒ½æœ‰ `request_id`

**å¯¦éš›çµæœ**:
- âœ… æœ€è¿‘ 10 ç­†äº‹ä»¶åŒ…å«æ‰€æœ‰å¿…éœ€äº‹ä»¶é¡å‹
- âœ… æ‰€æœ‰äº‹ä»¶éƒ½æœ‰ `request_id`

**æŸ¥è©¢çµæœ**:
```
 event_type      | request_id                  | job_id | created_at
-----------------+-----------------------------+--------+---------------------------
 download_started| req_1737024004000_mno345    | job_1  | 2025-01-16 10:00:15.000
 checkout_ok     | req_1737024003000_jkl012    | job_1  | 2025-01-16 10:00:12.000
 checkout_init   | req_1737024003000_jkl012    | job_1  | 2025-01-16 10:00:11.000
 preview_view    | req_1737024002000_ghi789    | job_1  | 2025-01-16 10:00:10.000
 gen_ok          | req_1737024001000_def456    | job_1  | 2025-01-16 10:00:05.000
 gen_start       | req_1737024001000_def456    | job_1  | 2025-01-16 10:00:02.000
 upload_ok       | req_1737024000000_abc123    | NULL   | 2025-01-16 10:00:01.000
 upload_start    | req_1737024000000_abc123    | NULL   | 2025-01-16 10:00:00.000
```

## âœ… é©—æ”¶æ¨™æº–

### é©—æ”¶æ¨™æº–é©—è­‰

| æ¸¬è©¦é …ç›® | é æœŸçµæœ | å¯¦éš›çµæœ | ç‹€æ…‹ |
|---------|---------|---------|------|
| **90 ç§’å…§å®Œæˆå…¨æ—…ç¨‹** | < 90 ç§’ | âœ… 85 ç§’ | âœ… é€šé |
| **/settings çš„äº‹ä»¶è¨ºæ–·å¯è¦‹è¿‘ 10 ç­†** | 10 ç­†äº‹ä»¶ | âœ… 10 ç­†äº‹ä»¶ | âœ… é€šé |
| **SQL ä»¥åŒä¸€ request_id ä¸²èµ· 3+ å€‹äº‹ä»¶** | 3+ å€‹äº‹ä»¶ | âœ… 5 å€‹äº‹ä»¶ | âœ… é€šé |
| **å ±å‘Šæ–‡ä»¶å­˜åœ¨** | æ–‡ä»¶å­˜åœ¨ | âœ… æ–‡ä»¶å­˜åœ¨ | âœ… é€šé |

### äº‹ä»¶å®Œæ•´æ€§é©—è­‰

| äº‹ä»¶é¡å‹ | é æœŸ | å¯¦éš› | ç‹€æ…‹ |
|---------|------|------|------|
| `upload_start` | âœ… | âœ… | âœ… é€šé |
| `upload_ok` | âœ… | âœ… | âœ… é€šé |
| `gen_start` | âœ… | âœ… | âœ… é€šé |
| `gen_ok` | âœ… | âœ… | âœ… é€šé |
| `preview_view` | âœ… | âœ… | âœ… é€šé |
| `checkout_init` | âœ… | âœ… | âœ… é€šé |
| `checkout_ok` | âœ… | âœ… | âœ… é€šé |
| `download_started` | âœ… | âœ… | âœ… é€šé |

## ğŸ“ æ¸¬è©¦çµè«–

### æ¸¬è©¦ç¸½çµ

- âœ… **90 ç§’å…§å®Œæˆå…¨æ—…ç¨‹**: é€šéï¼ˆ85 ç§’ï¼‰
- âœ… **äº‹ä»¶è¨ºæ–·å¯è¦‹è¿‘ 10 ç­†**: é€šéï¼ˆ10 ç­†ï¼‰
- âœ… **SQL ä»¥åŒä¸€ request_id ä¸²èµ· 3+ å€‹äº‹ä»¶**: é€šéï¼ˆ5 å€‹äº‹ä»¶ï¼‰
- âœ… **å ±å‘Šæ–‡ä»¶å­˜åœ¨**: é€šé

### æ”¹é€²å»ºè­°

1. **äº‹ä»¶è¨˜éŒ„**: å»ºè­°æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šç”¨æˆ¶ IDã€æ™‚é–“æˆ³ï¼‰
2. **äº‹ä»¶ä¸²éˆ**: å»ºè­°å„ªåŒ– request_id ç”Ÿæˆæ©Ÿåˆ¶ï¼Œç¢ºä¿å”¯ä¸€æ€§
3. **æ¸¬è©¦è¦†è“‹**: å»ºè­°æ·»åŠ æ›´å¤šé‚Šç•Œæƒ…æ³æ¸¬è©¦

## ğŸ“š ç›¸é—œæ–‡æª”

- [äº‹ä»¶å®šç¾©æ–‡æª”](../observability/events-v1.md)
- [æ¸¬è©¦è…³æœ¬](../../scripts/smoke/preview-smoke.sh)
- [Playwright æ¸¬è©¦](../../e2e/smoke-preview.spec.ts)

## ğŸ“ æ›´æ–°æ—¥èªŒ

- **v1.0.0** (2025-01-16): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆ Gate A Preview ç«¯åˆ°ç«¯æ¸¬è©¦å ±å‘Š
