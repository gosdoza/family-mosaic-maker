# Retention æ’ç¨‹ Runbook

**ç‰ˆæœ¬**: v1.0.0  
**æœ€å¾Œæ›´æ–°**: 2025-01-16

æœ¬æ–‡æ¡£è¯´æ˜ Retention æ¸…ç†æ’ç¨‹çš„é…ç½®ã€æ‰§è¡Œã€ç›‘æ§å’Œæ•…éšœå¤„ç†æµç¨‹ã€‚

## ğŸ“‹ ç›®éŒ„

- [æ’ç¨‹æ¦‚è¿°](#æ’ç¨‹æ¦‚è¿°)
- [æ’ç¨‹æ™‚é–“](#æ’ç¨‹æ™‚é–“)
- [æ¸…ç†è¦å‰‡](#æ¸…ç†è¦å‰‡)
- [åŸ·è¡Œæ–¹å¼](#åŸ·è¡Œæ–¹å¼)
- [å¤±æ•—è™•ç½®](#å¤±æ•—è™•ç½®)
- [é™ç´š/å›æ»¾](#é™ç´šå›æ»¾)
- [ç°åº¦â†’å…¨é‡ä¸Šç·šæµç¨‹](#ç°åº¦å…¨é‡ä¸Šç·šæµç¨‹)
- [èª¤åˆªå›å¾©æ­¥é©Ÿ](#èª¤åˆªå›å¾©æ­¥é©Ÿ)

## â° æ’ç¨‹æ¦‚è¿°

### ç›®çš„

å®šæœŸæ¸…ç†éæœŸæ–‡ä»¶ï¼ŒåŒ…æ‹¬ï¼š
- **originals**: 72 å°æ™‚å¾Œè‡ªå‹•æ¸…ç†
- **previews**: 7 å¤©å¾Œè‡ªå‹•æ¸…ç†
- **analytics_logs**: 180 å¤©å¾Œè‡ªå‹•æ¸…ç†

### å„ªå…ˆç´š

1. **Edge Cron**ï¼ˆå„ªå…ˆï¼‰ï¼šä½¿ç”¨ Vercel Cron Jobs
2. **pg_cron**ï¼ˆå‚™é¸ï¼‰ï¼šä½¿ç”¨ Supabase pg_cronï¼ˆè‹¥ Edge Cron ä¸å¯ç”¨ï¼‰

## ğŸ“… æ’ç¨‹æ™‚é–“

### Edge Cronï¼ˆVercelï¼‰

**æ’ç¨‹æ™‚é–“**: æ¯å¤©å‡Œæ™¨ 2:00 UTC

**é…ç½®ä½ç½®**: `vercel.json`

```json
{
  "crons": [
    {
      "path": "/api/cron/retention",
      "schedule": "0 2 * * *"
    }
  ]
}
```

### pg_cronï¼ˆSupabaseï¼‰

**æ’ç¨‹æ™‚é–“**: æ¯å¤©å‡Œæ™¨ 2:00 UTC

**SQL é…ç½®**:
```sql
SELECT cron.schedule(
  'retention-cleanup',
  '0 2 * * *', -- æ¯å¤©å‡Œæ™¨ 2:00 UTC
  $$SELECT cleanup_retention()$$
);
```

## ğŸ§¹ æ¸…ç†è¦å‰‡

### æ¸…ç†è¦å‰‡è¡¨

| è³‡æºé¡å‹ | ä¿ç•™æœŸé™ | æ¸…ç†æ™‚é–“ | èªªæ˜ |
|---------|---------|---------|------|
| **originals** | 72 å°æ™‚ | æ¯å¤©å‡Œæ™¨ 2:00 | åŸåœ–ä¸Šå‚³å¾Œ 72 å°æ™‚è‡ªå‹•æ¸…ç† |
| **previews** | 7 å¤© | æ¯å¤©å‡Œæ™¨ 2:00 | é è¦½åœ–å‰µå»ºå¾Œ 7 å¤©è‡ªå‹•æ¸…ç† |
| **analytics_logs** | 180 å¤© | æ¯å¤©å‡Œæ™¨ 2:00 | åˆ†ææ—¥èªŒå‰µå»ºå¾Œ 180 å¤©è‡ªå‹•æ¸…ç† |

### æ¸…ç†é‚è¼¯

1. **æŸ¥è©¢éæœŸæ–‡ä»¶**: æ ¹æ“š `created_at` æˆ– `uploaded_at` åˆ¤æ–·æ˜¯å¦éæœŸ
2. **ç°åº¦åˆªé™¤**: é è¨­ 10% ç°åº¦åˆªé™¤ï¼Œé€æ­¥å¢åŠ åˆ° 100%
3. **è¨˜éŒ„çµ±è¨ˆ**: å°‡åˆªé™¤çµ±è¨ˆå¯«å…¥ `analytics_logs` (type: `retention`)

## ğŸš€ åŸ·è¡Œæ–¹å¼

### 1. è‡ªå‹•æ’ç¨‹ï¼ˆEdge Cronï¼‰

**è§¸ç™¼æ–¹å¼**: Vercel Cron Jobs è‡ªå‹•è§¸ç™¼

**ç«¯é»**: `GET /api/cron/retention`

**åŸ·è¡Œé »ç‡**: æ¯å¤©å‡Œæ™¨ 2:00 UTC

### 2. æ‰‹å‹•è§¸ç™¼

**è…³æœ¬**: `scripts/retention/cleanup.mjs`

**ä½¿ç”¨æ–¹æ³•**:
```bash
# Dry-run æ¨¡å¼ï¼ˆåƒ…æ¨¡æ“¬ï¼‰
node scripts/retention/cleanup.mjs --dry-run

# 10% ç°åº¦åˆªé™¤
node scripts/retention/cleanup.mjs --percent=10

# å…¨é‡åˆªé™¤
node scripts/retention/cleanup.mjs
```

### 3. åƒ…è®€ç¨½æ ¸

**è…³æœ¬**: `scripts/retention/audit.mjs`

**ä½¿ç”¨æ–¹æ³•**:
```bash
node scripts/retention/audit.mjs
```

**ç”¨é€”**: æª¢æŸ¥éæœŸæ–‡ä»¶æ•¸é‡ï¼Œä¸å¯¦éš›åˆªé™¤

## âš ï¸ å¤±æ•—è™•ç½®

### éŒ¯èª¤è™•ç†æµç¨‹

1. **è‡ªå‹•é™ç´š**: é‡éŒ¯è‡ªå‹•é™å› dry-run æ¨¡å¼
2. **éŒ¯èª¤è¨˜éŒ„**: å°‡éŒ¯èª¤ä¿¡æ¯å¯«å…¥ `analytics_logs`
3. **å‘Šè­¦é€šçŸ¥**: ç™¼é€å‘Šè­¦é€šçŸ¥ï¼ˆå¯é¸ï¼‰

### éŒ¯èª¤é¡å‹

| éŒ¯èª¤é¡å‹ | è™•ç†æ–¹å¼ | èªªæ˜ |
|---------|---------|------|
| **ç¶²çµ¡éŒ¯èª¤** | è‡ªå‹•é‡è©¦ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰ | ç¶²çµ¡é€£æ¥å¤±æ•—æ™‚è‡ªå‹•é‡è©¦ |
| **æ¬Šé™éŒ¯èª¤** | è¨˜éŒ„éŒ¯èª¤ä¸¦åœæ­¢ | æ¬Šé™ä¸è¶³æ™‚åœæ­¢åŸ·è¡Œ |
| **æ•¸æ“šåº«éŒ¯èª¤** | è¨˜éŒ„éŒ¯èª¤ä¸¦åœæ­¢ | æ•¸æ“šåº«æ“ä½œå¤±æ•—æ™‚åœæ­¢åŸ·è¡Œ |
| **å­˜å„²éŒ¯èª¤** | è¨˜éŒ„éŒ¯èª¤ä¸¦ç¹¼çºŒ | å–®å€‹æ–‡ä»¶åˆªé™¤å¤±æ•—æ™‚ç¹¼çºŒè™•ç†å…¶ä»–æ–‡ä»¶ |

### å¤±æ•—è™•ç½®æ­¥é©Ÿ

1. **æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ**: æŸ¥çœ‹ `analytics_logs` ä¸­çš„éŒ¯èª¤è¨˜éŒ„
2. **ç¢ºèªéŒ¯èª¤åŸå› **: åˆ†æéŒ¯èª¤ä¿¡æ¯ï¼Œç¢ºå®šéŒ¯èª¤é¡å‹
3. **ä¿®å¾©å•é¡Œ**: æ ¹æ“šéŒ¯èª¤é¡å‹ä¿®å¾©å•é¡Œ
4. **é‡æ–°åŸ·è¡Œ**: ä¿®å¾©å¾Œé‡æ–°åŸ·è¡Œæ¸…ç†è…³æœ¬

## ğŸ”„ é™ç´š/å›æ»¾

### é™ç´šæµç¨‹

**è§¸ç™¼æ¢ä»¶**: åŸ·è¡Œéç¨‹ä¸­é‡åˆ°éŒ¯èª¤

**é™ç´šæ­¥é©Ÿ**:
1. è‡ªå‹•åˆ‡æ›åˆ° dry-run æ¨¡å¼
2. è¨˜éŒ„é™ç´šåŸå› åˆ° `analytics_logs`
3. ç™¼é€å‘Šè­¦é€šçŸ¥ï¼ˆå¯é¸ï¼‰

### å›æ»¾æµç¨‹

**è§¸ç™¼æ¢ä»¶**: ç™¼ç¾èª¤åˆªæˆ–ç•°å¸¸åˆªé™¤

**å›æ»¾æ­¥é©Ÿ**:
1. **åœæ­¢è‡ªå‹•æ¸…ç†**: ç¦ç”¨ Edge Cron æˆ– pg_cron
2. **æª¢æŸ¥åˆªé™¤è¨˜éŒ„**: æŸ¥çœ‹ `analytics_logs` ä¸­çš„åˆªé™¤è¨˜éŒ„
3. **æ¢å¾©æ•¸æ“š**: å¾å‚™ä»½æ¢å¾©è¢«èª¤åˆªçš„æ–‡ä»¶ï¼ˆå¦‚æœå¯èƒ½ï¼‰
4. **ä¿®å¾©å•é¡Œ**: ä¿®å¾©å°è‡´èª¤åˆªçš„å•é¡Œ
5. **é‡æ–°å•Ÿç”¨**: ä¿®å¾©å¾Œé‡æ–°å•Ÿç”¨è‡ªå‹•æ¸…ç†

## ğŸ“ˆ ç°åº¦â†’å…¨é‡ä¸Šç·šæµç¨‹

### éšæ®µ 1: Dry-runï¼ˆ0%ï¼‰

**ç›®çš„**: é©—è­‰æ¸…ç†é‚è¼¯æ­£ç¢ºæ€§

**åŸ·è¡Œæ–¹å¼**:
```bash
node scripts/retention/cleanup.mjs --dry-run
```

**é©—è­‰é»**:
- æŸ¥è©¢é‚è¼¯æ­£ç¢º
- éæœŸåˆ¤æ–·æº–ç¢º
- çµ±è¨ˆè¨˜éŒ„å®Œæ•´

### éšæ®µ 2: 10% ç°åº¦

**ç›®çš„**: å°è¦æ¨¡æ¸¬è©¦å¯¦éš›åˆªé™¤

**åŸ·è¡Œæ–¹å¼**:
```bash
node scripts/retention/cleanup.mjs --percent=10
```

**é©—è­‰é»**:
- åˆªé™¤æ•¸é‡ â‰ˆ é æœŸ 10%
- åˆªé™¤æ“ä½œæˆåŠŸ
- çµ±è¨ˆè¨˜éŒ„æº–ç¢º

### éšæ®µ 3: 50% ç°åº¦

**ç›®çš„**: ä¸­ç­‰è¦æ¨¡æ¸¬è©¦

**åŸ·è¡Œæ–¹å¼**:
```bash
node scripts/retention/cleanup.mjs --percent=50
```

**é©—è­‰é»**:
- åˆªé™¤æ•¸é‡ â‰ˆ é æœŸ 50%
- ç„¡ç•°å¸¸éŒ¯èª¤
- ç³»çµ±æ€§èƒ½æ­£å¸¸

### éšæ®µ 4: 100% å…¨é‡

**ç›®çš„**: æ­£å¼ä¸Šç·š

**åŸ·è¡Œæ–¹å¼**:
```bash
node scripts/retention/cleanup.mjs
```

**é©—è­‰é»**:
- åˆªé™¤æ•¸é‡ = é æœŸ 100%
- æ‰€æœ‰éæœŸæ–‡ä»¶å·²æ¸…ç†
- ç³»çµ±é‹è¡Œæ­£å¸¸

### ç°åº¦ä¸Šç·šæª¢æŸ¥æ¸…å–®

- [ ] Dry-run æ¸¬è©¦é€šé
- [ ] 10% ç°åº¦æ¸¬è©¦é€šé
- [ ] 50% ç°åº¦æ¸¬è©¦é€šéï¼ˆå¯é¸ï¼‰
- [ ] ç›£æ§ç³»çµ±æ­£å¸¸
- [ ] å‘Šè­¦è¦å‰‡å·²è¨­ç½®
- [ ] å›æ»¾è¨ˆåŠƒå·²æº–å‚™

## ğŸ”™ èª¤åˆªå›å¾©æ­¥é©Ÿ

### æ­¥é©Ÿ 1: ç«‹å³åœæ­¢æ¸…ç†

**æ“ä½œ**:
```bash
# ç¦ç”¨ Edge Cronï¼ˆVercel Dashboardï¼‰
# æˆ–
# ç¦ç”¨ pg_cronï¼ˆSupabase SQL Editorï¼‰
SELECT cron.unschedule('retention-cleanup');
```

### æ­¥é©Ÿ 2: æª¢æŸ¥åˆªé™¤è¨˜éŒ„

**æŸ¥è©¢ SQL**:
```sql
SELECT 
  event_data->>'results' as results,
  created_at
FROM analytics_logs
WHERE event_type = 'retention'
ORDER BY created_at DESC
LIMIT 10;
```

**æª¢æŸ¥å…§å®¹**:
- åˆªé™¤çš„æ–‡ä»¶ IDï¼ˆsampleï¼‰
- åˆªé™¤æ™‚é–“
- åˆªé™¤æ•¸é‡

### æ­¥é©Ÿ 3: ç¢ºèªèª¤åˆªç¯„åœ

**æ“ä½œ**:
1. æŸ¥çœ‹ `analytics_logs` ä¸­çš„ `sample` å­—æ®µ
2. ç¢ºèªèª¤åˆªçš„æ–‡ä»¶ ID
3. è©•ä¼°èª¤åˆªå½±éŸ¿ç¯„åœ

### æ­¥é©Ÿ 4: æ¢å¾©æ•¸æ“šï¼ˆå¦‚æœå¯èƒ½ï¼‰

**æ“ä½œ**:
1. **æª¢æŸ¥å‚™ä»½**: æŸ¥çœ‹æ˜¯å¦æœ‰å‚™ä»½å¯æ¢å¾©
2. **æ¢å¾©æ–‡ä»¶**: å¾å‚™ä»½æ¢å¾©è¢«èª¤åˆªçš„æ–‡ä»¶
3. **é©—è­‰æ¢å¾©**: ç¢ºèªæ¢å¾©çš„æ–‡ä»¶å®Œæ•´å¯ç”¨

### æ­¥é©Ÿ 5: ä¿®å¾©å•é¡Œ

**æ“ä½œ**:
1. **åˆ†æåŸå› **: ç¢ºå®šå°è‡´èª¤åˆªçš„æ ¹æœ¬åŸå› 
2. **ä¿®å¾©ä»£ç¢¼**: ä¿®å¾©æ¸…ç†é‚è¼¯ä¸­çš„å•é¡Œ
3. **æ¸¬è©¦é©—è­‰**: é‡æ–°æ¸¬è©¦æ¸…ç†é‚è¼¯

### æ­¥é©Ÿ 6: é‡æ–°å•Ÿç”¨

**æ“ä½œ**:
1. **é‡æ–°æ¸¬è©¦**: ä½¿ç”¨ dry-run æ¨¡å¼é‡æ–°æ¸¬è©¦
2. **ç°åº¦ä¸Šç·š**: æŒ‰ç…§ç°åº¦â†’å…¨é‡æµç¨‹é‡æ–°ä¸Šç·š
3. **ç›£æ§é‹è¡Œ**: å¯†åˆ‡ç›£æ§æ¸…ç†ä»»å‹™é‹è¡Œæƒ…æ³

## ğŸ“Š ç›£æ§æŒ‡æ¨™

### é—œéµæŒ‡æ¨™

| æŒ‡æ¨™ | èªªæ˜ | å‘Šè­¦é–¾å€¼ |
|------|------|---------|
| **åˆªé™¤æ•¸é‡** | æ¯æ¬¡æ¸…ç†åˆªé™¤çš„æ–‡ä»¶æ•¸é‡ | ç•°å¸¸å¢åŠ  |
| **åŸ·è¡Œæ™‚é–“** | æ¸…ç†ä»»å‹™åŸ·è¡Œæ™‚é–“ | > 5 åˆ†é˜ |
| **éŒ¯èª¤ç‡** | æ¸…ç†ä»»å‹™éŒ¯èª¤ç‡ | > 5% |
| **éæœŸæ–‡ä»¶æ•¸** | ç•¶å‰éæœŸæ–‡ä»¶æ•¸é‡ | æŒçºŒå¢é•· |

### ç›£æ§æŸ¥è©¢

**æŸ¥è©¢æœ€è¿‘ä¸€æ¬¡æ¸…ç†çµæœ**:
```sql
SELECT 
  event_data->>'results' as results,
  event_data->>'dryRun' as dryRun,
  event_data->>'percent' as percent,
  created_at
FROM analytics_logs
WHERE event_type = 'retention'
ORDER BY created_at DESC
LIMIT 1;
```

## ğŸ“ ç›¸é—œæ–‡æª”

- [è³‡æ–™ä¿ç•™ç­–ç•¥](./db/retention.md)
- [å¥åº·æª¢æŸ¥åˆç´„](./health_contract.md)
- [å®‰å…¨å¯†é‘°ç®¡ç†](./security_keys.md)

## ğŸ“ æ›´æ–°æ—¥èªŒ

- **v1.0.0** (2025-01-16): åˆå§‹ç‰ˆæœ¬ï¼Œå®šç¾© Retention æ’ç¨‹ Runbook



